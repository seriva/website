<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portfolio Tests</title>
    
    <!-- QUnit CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.20.0.css">
    
    <!-- Prism.js theme (for testing) -->
    <link rel="stylesheet" id="prism-theme" href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism-tomorrow.min.css" crossorigin="anonymous">
    
    <!-- Your existing styles -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- QUnit Test UI -->
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    
    <!-- Minimal HTML structure for testing -->
    <div id="navbar-container"></div>
    <main id="main-content"></main>
    <div id="footer-container"></div>
    
    <!-- QUnit JavaScript -->
    <script src="https://code.jquery.com/qunit/qunit-2.20.0.js"></script>
    
    <!-- Load only the core JavaScript (no external dependencies) -->
    <script>
        // Constants
        const CONSTANTS = {
            PRISM_CDN_BASE: "https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/",
            DEFAULT_THEME: "prism-tomorrow",
            DEFAULT_TITLE: "portfolio.example.com",
            DEFAULT_EMAIL: "contact@example.com",
            GITHUB_RAW_BASE: "https://raw.githubusercontent.com",
            MOBILE_BREAKPOINT: 767,
            SEARCH_DEBOUNCE_MS: 300,
            PAGE_TRANSITION_DELAY: 200,
            SEARCH_PAGE_CLOSE_DELAY: 200,
            SEARCH_MIN_CHARS: 2,
            SEARCH_MAX_RESULTS: 8,
        };

        // Utility Functions
        const escapeHtml = (str) => {
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
        };

        window.setDocumentTitle = (data) => {
            document.title = data?.site?.title || CONSTANTS.DEFAULT_TITLE;
        };

        const html = (strings, ...values) => {
            return strings.reduce((result, str, i) => {
                const value = values[i];
                if (value === undefined || value === null) return result + str;
                if (value?.__safe) return result + str + value.content;
                return result + str + escapeHtml(String(value));
            }, "");
        };

        const safe = (content) => ({ __safe: true, content });

        // Templates
        window.Templates = {
            navbar: (blogLink, projectsDropdown, pageLinks, socialLinksHtml, searchBar, siteTitle) => html`
                <nav class="navbar">
                    <div class="navbar-container">
                        <a class="navbar-brand" href="#">${siteTitle}</a>
                        <button class="navbar-toggle" id="navbar-toggle" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggle-icon"></span>
                        </button>
                        <div class="navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav left">
                                ${safe(blogLink)}
                                ${safe(projectsDropdown)}
                                ${safe(pageLinks)}
                            </ul>
                            <ul class="navbar-nav right">
                                ${safe(searchBar)}
                                ${safe(socialLinksHtml)}
                            </ul>
                        </div>
                    </div>
                </nav>
            `,

            pageLink: (pageId, pageTitle) => {
                const href = pageId === "blog" ? "?blog" : `/?page=${pageId}`;
                return html`<li class="nav-item navbar-menu"><a class="nav-link" href="${href}" data-spa-route="page">${pageTitle}</a></li>`;
            },

            socialLink: ({ href = "#", onclick = "", target = "", icon = "fas fa-link", ariaLabel = "" }) => {
                const attrs = [
                    href && `href="${href}"`,
                    onclick && `onclick="${onclick}"`,
                    target && `target="${target}"`,
                    ariaLabel && `aria-label="${ariaLabel}"`
                ].filter(Boolean).join(" ");
                
                return html`<li class="nav-item navbar-icon"><a class="nav-link" ${safe(attrs)}><i class="${icon}"></i></a></li>`;
            },

            loadingSpinner: () => html`<div class="loading-spinner">Loading...</div>`,

            errorMessage: (title, message) => html`
                <div class="error-message">
                    <h1>${title}</h1>
                    <p>${message}</p>
                </div>
            `,

            markdown: (content) => {
                if (typeof marked === "undefined") {
                    return html`<div class="markdown-body"><p>Markdown renderer not available</p></div>`;
                }
                try {
                    const htmlContent = marked.parse(content);
                    return safe(`<div class="markdown-body">${htmlContent}</div>`);
                } catch (error) {
                    console.error("Error rendering markdown:", error);
                    return html`<div class="markdown-body"><p>Error rendering markdown</p></div>`;
                }
            },

            giscusComments: (config, pageType = "blog") => {
                // Check if comments are enabled for this page type
                const isEnabled = pageType === "blog" ? config?.blogEnabled : config?.projectsEnabled;
                if (!isEnabled) return "";

                // Create a unique container ID
                const containerId = `giscus-${pageType}-${Date.now()}`;

                // Schedule script injection for after DOM update
                setTimeout(() => {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    const script = document.createElement("script");
                    script.src = "https://giscus.app/client.js";
                    script.setAttribute("data-repo", config.repo);
                    script.setAttribute("data-repo-id", config.repoId);
                    script.setAttribute("data-category", config.category);
                    script.setAttribute("data-category-id", config.categoryId);
                    script.setAttribute("data-mapping", config.mapping);
                    script.setAttribute("data-strict", config.strict);
                    script.setAttribute("data-reactions-enabled", config.reactionsEnabled);
                    script.setAttribute("data-emit-metadata", config.emitMetadata);
                    script.setAttribute("data-input-position", config.inputPosition);
                    script.setAttribute("data-theme", config.theme);
                    script.setAttribute("data-lang", config.lang);
                    script.setAttribute("crossorigin", "anonymous");
                    script.async = true;

                    container.appendChild(script);
                }, 100);

                return html`<div class="giscus-container" id="${containerId}"></div>`;
            },
        };

        // Search object (minimal)
        window.Search = {
            data: [],
            isInitialized: false,
            init: function() { this.isInitialized = true; },
            search: function(query) { 
                if (!query || query.length < CONSTANTS.SEARCH_MIN_CHARS) return [];
                return this.data.filter(item => 
                    item.title.toLowerCase().includes(query.toLowerCase()) ||
                    item.description.toLowerCase().includes(query.toLowerCase())
                ).slice(0, CONSTANTS.SEARCH_MAX_RESULTS);
            }
        };

        // DOMCache (complete)
        window.DOMCache = {
            navbar: null,
            main: null,
            footer: null,
            dropdownMenu: null,
            navbarLinks: null,
            searchPage: null,
            searchPageInput: null,
            searchPageResults: null,
            searchToggle: null,

            init: function() {
                this.navbar = document.getElementById("navbar-container");
                this.main = document.getElementById("main-content");
                this.footer = document.getElementById("footer-container");
            },

            clearNavbarCache: function() {
                this.dropdownMenu = null;
                this.navbarLinks = null;
                this.searchToggle = null;
            },

            clearSearchCache: function() {
                this.searchPage = null;
                this.searchPageInput = null;
                this.searchPageResults = null;
                this.searchToggle = null;
            },

            getDropdown: function() {
                if (!this.dropdownMenu) {
                    this.dropdownMenu = document.getElementById("projects-dropdown");
                }
                return this.dropdownMenu;
            },

            getSearchPage: function() {
                if (!this.searchPage) {
                    this.searchPage = document.getElementById("search-page");
                }
                return this.searchPage;
            },

            getSearchInput: function() {
                if (!this.searchPageInput) {
                    this.searchPageInput = document.getElementById("search-page-input");
                }
                return this.searchPageInput;
            },

            getSearchResults: function() {
                if (!this.searchPageResults) {
                    this.searchPageResults = document.getElementById("search-page-results");
                }
                return this.searchPageResults;
            },

            getSearchToggle: function() {
                if (!this.searchToggle) {
                    this.searchToggle = document.getElementById("search-toggle");
                }
                return this.searchToggle;
            }
        };
    </script>
    
    <!-- Essential test files only -->
    <script src="tests/test-utils.js"></script>
    <script src="tests/test-templates.js"></script>
    <script src="tests/test-search.js"></script>
    <script src="tests/test-routing.js"></script>
    <script src="tests/test-dom.js"></script>
    
    <script>
        // Initialize DOMCache
        DOMCache.init();
        
        console.log('ðŸ§ª Simple tests loaded - no app initialization');
    </script>
</body>
</html>
